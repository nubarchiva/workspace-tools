#!/bin/bash
# Cambia al workspace especificado y muestra su informaciÃ³n

WORKSPACE_PATTERN=$1

# Detectar WORKSPACE_ROOT desde WS_TOOLS o por defecto
if [ -n "$WS_TOOLS" ]; then
    WORKSPACE_ROOT="${WS_TOOLS%/tools/workspace-tools}"
else
    # Fallback: asumir ubicaciÃ³n estÃ¡ndar
    WORKSPACE_ROOT=~/wrkspc.nubarchiva
fi
WORKSPACES_DIR=$WORKSPACE_ROOT/workspaces

# Detectar directorio del script (compatible bash/zsh)
if [ -n "$BASH_SOURCE" ]; then
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
else
    SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
fi

# Cargar funciones compartidas
source "$SCRIPT_DIR/ws-common.sh"
source "$SCRIPT_DIR/ws-colors.sh"

# FunciÃ³n de ayuda
show_help() {
    echo "Uso: ws switch [nombre|patrÃ³n]"
    echo ""
    echo "ğŸ’¡ Puedes usar coincidencia parcial para el nombre del workspace"
    echo ""
    echo "Ejemplos:"
    echo "  ws switch                    # lista workspaces disponibles"
    echo "  ws switch master"
    echo "  ws switch nuba-8400"
    echo "  ws switch fac                # busca 'fac' en workspaces"
}

# Si no hay argumentos, listar workspaces
if [ -z "$WORKSPACE_PATTERN" ]; then
    echo "Workspaces disponibles:"
    echo ""

    if [ -d "$WORKSPACES_DIR" ]; then
        for workspace_dir in "$WORKSPACES_DIR"/*; do
            if [ -d "$workspace_dir" ]; then
                workspace_name=$(basename "$workspace_dir")
                branch_name=$(get_branch_name "$workspace_name")
                echo "  â€¢ ${COLOR_CYAN}$workspace_name${COLOR_RESET} ${COLOR_DIM}(branch: $branch_name)${COLOR_RESET}"
            fi
        done
    fi

    echo ""
    show_help
    exit 0
fi

# Buscar workspace que coincida con el patrÃ³n
WORKSPACE_NAME=$(find_matching_workspace "$WORKSPACE_PATTERN" "$WORKSPACES_DIR")
if [ $? -ne 0 ]; then
    exit 1
fi

# Determinar directorio del workspace
WORKSPACE_DIR=$WORKSPACES_DIR/$WORKSPACE_NAME
BRANCH_NAME=$(get_branch_name "$WORKSPACE_NAME")

if [ ! -d "$WORKSPACE_DIR" ]; then
    error "âŒ Workspace no existe: $WORKSPACE_NAME"
    echo ""
    echo "Workspaces disponibles:"
    $0
    exit 1
fi

# Mostrar informaciÃ³n del workspace
print_header "Workspace: ${COLOR_BOLD}$WORKSPACE_NAME${COLOR_RESET}"
echo ""

# Mostrar README si existe
if [ -f "$WORKSPACE_DIR/README.md" ]; then
    cat "$WORKSPACE_DIR/README.md"
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
fi

# Mostrar estado de cada repo (incluyendo subdirectorios)
echo "Estado de los repos:"
echo ""

repos=$(find_repos_in_workspace "$WORKSPACE_DIR")
has_repos=false

echo "$repos" | while read -r repo_rel_path; do
    if [ -n "$repo_rel_path" ]; then
        has_repos=true
        worktree_path="$WORKSPACE_DIR/$repo_rel_path"

        if [ -d "$worktree_path" ]; then
            echo "ğŸ“¦ ${COLOR_CYAN}$repo_rel_path${COLOR_RESET}:"
            cd "$worktree_path"

            # Branch actual
            current_branch=$(git branch --show-current)
            echo "   Branch: ${COLOR_CYAN}$current_branch${COLOR_RESET}"

            # Estado
            status=$(git status -s)
            if [ -z "$status" ]; then
                success "   âœ… Sin cambios"
            else
                warning "   âš ï¸  Cambios sin commitear:"
                git status -s | sed 's/^/      /'
            fi
            echo ""
        fi
    fi
done

if [ -z "$repos" ] || [ "$repos" = "" ]; then
    echo "  ${COLOR_DIM}(No hay repos en este workspace)${COLOR_RESET}"
    info "  ğŸ’¡ Usa 'ws add $WORKSPACE_NAME <repo>' para aÃ±adir"
    echo ""
fi

echo "${COLOR_DIM}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${COLOR_RESET}"
echo ""
echo "ğŸ“ Ruta: ${COLOR_CYAN}$WORKSPACE_DIR${COLOR_RESET}"
echo ""
echo "Para trabajar aquÃ­:"
echo "  ${COLOR_CYAN}cd $WORKSPACE_DIR${COLOR_RESET}"
echo ""

if [ -n "$repos" ]; then
    echo "O con un repo especÃ­fico:"
    echo "$repos" | while read -r repo_rel_path; do
        if [ -n "$repo_rel_path" ]; then
            echo "  ${COLOR_DIM}cd $WORKSPACE_DIR/$repo_rel_path${COLOR_RESET}"
        fi
    done
fi
