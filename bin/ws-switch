#!/bin/bash
# Cambia al workspace especificado y muestra su informaciÃ³n

WORKSPACE_TYPE=$1
WORKSPACE_NAME=$2

# Detectar WORKSPACE_ROOT automÃ¡ticamente (2 niveles arriba del script)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WORKSPACE_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
WORKSPACES_DIR=$WORKSPACE_ROOT/workspaces

# Cargar funciones compartidas
source "$SCRIPT_DIR/ws-common.sh"

# FunciÃ³n de ayuda
show_help() {
    echo "Uso: ws-switch <tipo> [nombre]"
    echo ""
    echo "Tipos:"
    echo "  master                       - Cambia a workspace master"
    echo "  develop                      - Cambia a workspace develop"
    echo "  feature <nombre>             - Cambia a una feature especÃ­fica"
    echo ""
    echo "Sin argumentos: lista workspaces disponibles"
    echo ""
    echo "Ejemplos:"
    echo "  ws-switch master"
    echo "  ws-switch feature faceted-search"
}

# Si no hay argumentos, listar workspaces
if [ -z "$WORKSPACE_TYPE" ]; then
    echo "Workspaces disponibles:"
    echo ""
    
    if [ -d "$WORKSPACES_DIR/master" ]; then
        echo "  â€¢ master"
    fi
    
    if [ -d "$WORKSPACES_DIR/develop" ]; then
        echo "  â€¢ develop"
    fi
    
    if [ -d "$WORKSPACES_DIR/features" ]; then
        for feature_dir in $WORKSPACES_DIR/features/*/; do
            if [ -d "$feature_dir" ]; then
                feature_name=$(basename $feature_dir)
                echo "  â€¢ feature/$feature_name"
            fi
        done
    fi
    
    echo ""
    show_help
    exit 0
fi

# Validar tipo de workspace
if [ "$WORKSPACE_TYPE" != "feature" ] && [ "$WORKSPACE_TYPE" != "master" ] && [ "$WORKSPACE_TYPE" != "develop" ]; then
    echo "âŒ Tipo invÃ¡lido: $WORKSPACE_TYPE"
    show_help
    exit 1
fi

# Para features, validar que se proporcione un patrÃ³n de bÃºsqueda
if [ "$WORKSPACE_TYPE" = "feature" ] && [ -z "$WORKSPACE_NAME" ]; then
    echo "âŒ Las features requieren un nombre o patrÃ³n de bÃºsqueda"
    show_help
    exit 1
fi

# Buscar workspace que coincida con el patrÃ³n
MATCHED_NAME=$(find_matching_workspace "$WORKSPACE_TYPE" "$WORKSPACE_NAME" "$WORKSPACES_DIR")
if [ $? -ne 0 ]; then
    exit 1
fi

# Determinar directorio del workspace
case $WORKSPACE_TYPE in
    feature)
        WORKSPACE_DIR=$WORKSPACES_DIR/features/$MATCHED_NAME
        DISPLAY_NAME="feature/$MATCHED_NAME"
        ;;
    master)
        WORKSPACE_DIR=$WORKSPACES_DIR/master
        DISPLAY_NAME="master"
        ;;
    develop)
        WORKSPACE_DIR=$WORKSPACES_DIR/develop
        DISPLAY_NAME="develop"
        ;;
esac

if [ ! -d "$WORKSPACE_DIR" ]; then
    echo "âŒ Workspace no existe: $DISPLAY_NAME"
    echo ""
    echo "Workspaces disponibles:"
    $0
    exit 1
fi

# Mostrar informaciÃ³n del workspace
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  Workspace: $DISPLAY_NAME"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Mostrar README si existe
if [ -f "$WORKSPACE_DIR/README.md" ]; then
    cat "$WORKSPACE_DIR/README.md"
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
fi

# Mostrar estado de cada repo (incluyendo subdirectorios)
echo "Estado de los repos:"
echo ""

repos=$(find_repos_in_workspace "$WORKSPACE_DIR")
has_repos=false

echo "$repos" | while read -r repo_rel_path; do
    if [ -n "$repo_rel_path" ]; then
        has_repos=true
        worktree_path="$WORKSPACE_DIR/$repo_rel_path"
        
        if [ -d "$worktree_path" ]; then
            echo "ğŸ“¦ $repo_rel_path:"
            cd "$worktree_path"
            
            # Branch actual
            current_branch=$(git branch --show-current)
            echo "   Branch: $current_branch"
            
            # Estado
            status=$(git status -s)
            if [ -z "$status" ]; then
                echo "   âœ… Sin cambios"
            else
                echo "   âš ï¸  Cambios sin commitear:"
                git status -s | sed 's/^/      /'
            fi
            echo ""
        fi
    fi
done

if [ -z "$repos" ] || [ "$repos" = "" ]; then
    echo "  (No hay repos en este workspace)"
    echo "  ğŸ’¡ Usa 'ws-add $WORKSPACE_TYPE $WORKSPACE_NAME <repo>' para aÃ±adir"
    echo ""
fi

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ“ Ruta: $WORKSPACE_DIR"
echo ""
echo "Para trabajar aquÃ­:"
echo "  cd $WORKSPACE_DIR"
echo ""

if [ -n "$repos" ]; then
    echo "O con un repo especÃ­fico:"
    echo "$repos" | while read -r repo_rel_path; do
        if [ -n "$repo_rel_path" ]; then
            echo "  cd $WORKSPACE_DIR/$repo_rel_path"
        fi
    done
fi
