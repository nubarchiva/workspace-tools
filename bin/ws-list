#!/bin/bash
# Lista todos los workspaces activos (opcionalmente filtrados por patrÃ³n)

# Inicializacion centralizada
source "$(dirname "${BASH_SOURCE[0]:-$0}")/ws-init.sh"

# PatrÃ³n de filtro opcional
FILTER_PATTERN=$1

if [ -n "$FILTER_PATTERN" ]; then
    print_header "WORKSPACES ACTIVOS (filtro: $FILTER_PATTERN)"
else
    print_header "WORKSPACES ACTIVOS"
fi
echo ""

# FunciÃ³n para calcular estado de sincronizaciÃ³n de un repo
# Retorna: "unpushed:pending_merge:behind"
# - unpushed: commits locales sin push (â†‘)
# - pending_merge: commits pusheados pero no en develop (â†)
# - behind: commits de develop que faltan (â†“)
get_sync_status() {
    local repo_path=$1
    local current_branch=$(git -C "$repo_path" branch --show-current 2>/dev/null)

    if [ -z "$current_branch" ]; then
        echo "0:0:0"
        return
    fi

    # Determinar branch base (develop o master)
    local base_branch=""
    if git -C "$repo_path" rev-parse --verify "origin/develop" >/dev/null 2>&1; then
        base_branch="origin/develop"
    elif git -C "$repo_path" rev-parse --verify "develop" >/dev/null 2>&1; then
        base_branch="develop"
    elif git -C "$repo_path" rev-parse --verify "origin/master" >/dev/null 2>&1; then
        base_branch="origin/master"
    elif git -C "$repo_path" rev-parse --verify "master" >/dev/null 2>&1; then
        base_branch="master"
    else
        echo "0:0:0"
        return
    fi

    local unpushed=0
    local pending_merge=0
    local behind=0

    # Commits de develop que no tenemos
    behind=$(git -C "$repo_path" rev-list --count "HEAD..$base_branch" 2>/dev/null || echo "0")

    # Verificar si tiene upstream (branch remota)
    local upstream=$(git -C "$repo_path" rev-parse --abbrev-ref "@{upstream}" 2>/dev/null)

    if [ -n "$upstream" ]; then
        # Commits locales sin push (--first-parent para no contar commits de merges)
        unpushed=$(git -C "$repo_path" rev-list --count --first-parent "$upstream..HEAD" 2>/dev/null || echo "0")
        # Commits pusheados pero no en develop
        pending_merge=$(git -C "$repo_path" rev-list --count "$base_branch..$upstream" 2>/dev/null || echo "0")
    else
        # Sin upstream: todos los commits adelante de develop son "pending_merge" conceptualmente
        # pero los mostramos como unpushed porque no han sido pusheados
        unpushed=$(git -C "$repo_path" rev-list --count --first-parent "$base_branch..HEAD" 2>/dev/null || echo "0")
    fi

    echo "$unpushed:$pending_merge:$behind"
}

# FunciÃ³n para mostrar workspace
show_workspace() {
    local name=$1
    local path=$2
    local branch=$(get_branch_name "$name")

    echo "ğŸ”¹ ${COLOR_BOLD_CYAN}$name${COLOR_RESET} ${COLOR_DIM}(branch: ${COLOR_CYAN}$branch${COLOR_RESET}${COLOR_DIM})${COLOR_RESET}"

    # Encontrar repos (incluyendo subdirectorios)
    local repos=$(find_repos_in_workspace "$path")
    local repo_count=$(echo "$repos" | grep -v '^$' | wc -l)

    if [ $repo_count -eq 0 ]; then
        echo "   ${COLOR_DIM}ğŸ“¦ Repos: 0${COLOR_RESET}"
        echo ""
        return
    fi

    echo "   ${COLOR_DIM}ğŸ“¦ Repos: $repo_count${COLOR_RESET}"

    # Listar repos con indicador de sincronizaciÃ³n
    echo "   ğŸ“‚ Contenido:"
    echo "$repos" | while read -r repo_rel_path; do
        if [ -n "$repo_rel_path" ]; then
            local worktree_path="$path/$repo_rel_path"
            local sync_indicator=""

            # Calcular sincronizaciÃ³n con develop (solo para workspaces que no son master/develop)
            if [[ "$name" != "master" && "$name" != "develop" ]] && [ -d "$worktree_path" ]; then
                local sync_status=$(get_sync_status "$worktree_path")
                # Parsear los 3 valores: unpushed:pending_merge:behind
                local unpushed=$(echo "$sync_status" | cut -d: -f1)
                local pending_merge=$(echo "$sync_status" | cut -d: -f2)
                local behind=$(echo "$sync_status" | cut -d: -f3)

                # Construir indicador con los 3 estados
                # â†‘ = commits sin push (amarillo)
                # â† = pusheado, pendiente merge a develop (cyan)
                # â†“ = develop tiene commits nuevos (magenta)
                if [ "$unpushed" -gt 0 ]; then
                    sync_indicator=" ${COLOR_YELLOW}â†‘$unpushed${COLOR_RESET}"
                fi
                if [ "$pending_merge" -gt 0 ]; then
                    sync_indicator="$sync_indicator ${COLOR_CYAN}â†$pending_merge${COLOR_RESET}"
                fi
                if [ "$behind" -gt 0 ]; then
                    sync_indicator="$sync_indicator ${COLOR_MAGENTA}â†“$behind${COLOR_RESET}"
                fi
            fi

            echo "      â€¢ $repo_rel_path$sync_indicator"
        fi
    done

    # Mostrar repos con cambios sin commitear
    has_uncommitted=false
    echo "$repos" | while read -r repo_rel_path; do
        if [ -n "$repo_rel_path" ]; then
            worktree_path="$path/$repo_rel_path"
            if git_has_uncommitted_changes "$worktree_path"; then
                if [ "$has_uncommitted" = false ]; then
                    echo "   ${COLOR_YELLOW}âš ï¸  Cambios sin commitear:${COLOR_RESET}"
                    has_uncommitted=true
                fi
                change_count=$(git_count_uncommitted_changes "$worktree_path")
                echo "      ${COLOR_YELLOW}â€¢ $repo_rel_path ($change_count archivos)${COLOR_RESET}"
            fi
        fi
    done

    # Mostrar repos con commits pendientes de push
    has_unpushed=false
    echo "$repos" | while read -r repo_rel_path; do
        if [ -n "$repo_rel_path" ]; then
            worktree_path="$path/$repo_rel_path"
            if git_has_unpushed_commits "$worktree_path"; then
                if [ "$has_unpushed" = false ]; then
                    echo "   ${COLOR_YELLOW}ğŸ“¤ Cambios sin push:${COLOR_RESET}"
                    has_unpushed=true
                fi
                unpushed_count=$(git_count_unpushed_commits "$worktree_path")
                if git_has_upstream "$worktree_path"; then
                    echo "      ${COLOR_YELLOW}â€¢ $repo_rel_path ($unpushed_count commits)${COLOR_RESET}"
                else
                    echo "      ${COLOR_YELLOW}â€¢ $repo_rel_path ($unpushed_count commits sin remoto)${COLOR_RESET}"
                fi
            fi
        fi
    done

    echo ""
}

# Contar workspaces
workspace_count=0
filtered_count=0

# Listar todos los workspaces (master, develop y cualquier otro)
if [ -d "$WORKSPACES_DIR" ]; then
    for workspace_dir in "$WORKSPACES_DIR"/*; do
        if [ -d "$workspace_dir" ]; then
            workspace_name=$(basename "$workspace_dir")
            ((workspace_count++))

            # Si hay filtro, verificar que el nombre coincida
            if [ -n "$FILTER_PATTERN" ]; then
                # BÃºsqueda parcial case-insensitive
                if [[ ! "$workspace_name" =~ "$FILTER_PATTERN" ]]; then
                    continue  # Saltar este workspace
                fi
            fi

            ((filtered_count++))
            show_workspace "$workspace_name" "$workspace_dir"
        fi
    done
fi

if [ $workspace_count -eq 0 ]; then
    echo "  ${COLOR_DIM}(No hay workspaces activos)${COLOR_RESET}"
    echo ""
    info "ğŸ’¡ Usa 'ws new <nombre> [repos...]' para crear uno"
    echo ""
elif [ -n "$FILTER_PATTERN" ] && [ $filtered_count -eq 0 ]; then
    echo "  ${COLOR_DIM}(No hay workspaces que coincidan con '$FILTER_PATTERN')${COLOR_RESET}"
    echo ""
    echo "${COLOR_DIM}Total de workspaces: $workspace_count${COLOR_RESET}"
    echo ""
else
    echo "${COLOR_DIM}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${COLOR_RESET}"
    if [ -n "$FILTER_PATTERN" ]; then
        echo "${COLOR_DIM}Mostrando: $filtered_count de $workspace_count workspaces${COLOR_RESET}"
    else
        echo "${COLOR_DIM}Total: $workspace_count workspaces${COLOR_RESET}"
    fi
    echo "${COLOR_DIM}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${COLOR_RESET}"
    echo ""
    info "ğŸ’¡ Usa 'ws switch <nombre>' para ver detalle de un workspace"
fi
