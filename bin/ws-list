#!/bin/bash
# Lista todos los workspaces activos

# Detectar WORKSPACE_ROOT desde WS_TOOLS o por defecto
if [ -n "$WS_TOOLS" ]; then
    WORKSPACE_ROOT="${WS_TOOLS%/tools/workspace-tools}"
else
    # Fallback: asumir ubicaciÃ³n estÃ¡ndar
    WORKSPACE_ROOT=~/wrkspc.nubarchiva
fi
WORKSPACES_DIR=$WORKSPACE_ROOT/workspaces

# Detectar directorio del script (compatible bash/zsh)
if [ -n "$BASH_SOURCE" ]; then
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
else
    SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
fi

# Cargar funciones compartidas
source "$SCRIPT_DIR/ws-common.sh"

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘           WORKSPACES ACTIVOS                       â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# FunciÃ³n para mostrar workspace
show_workspace() {
    local name=$1
    local path=$2
    local branch=$(get_branch_name "$name")

    echo "ğŸ”¹ $name (branch: $branch)"

    # Encontrar repos (incluyendo subdirectorios)
    local repos=$(find_repos_in_workspace "$path")
    local repo_count=$(echo "$repos" | grep -v '^$' | wc -l)

    if [ $repo_count -eq 0 ]; then
        echo "   ğŸ“¦ Repos: 0"
        echo ""
        return
    fi

    echo "   ğŸ“¦ Repos: $repo_count"

    # Listar repos
    echo "   ğŸ“‚ Contenido:"
    echo "$repos" | while read -r repo_rel_path; do
        if [ -n "$repo_rel_path" ]; then
            echo "      â€¢ $repo_rel_path"
        fi
    done

    # Mostrar repos con cambios sin commitear
    has_uncommitted=false
    echo "$repos" | while read -r repo_rel_path; do
        if [ -n "$repo_rel_path" ]; then
            worktree_path="$path/$repo_rel_path"
            if [ -d "$worktree_path" ]; then
                cd "$worktree_path"
                if [ -n "$(git status -s 2>/dev/null)" ]; then
                    if [ "$has_uncommitted" = false ]; then
                        echo "   âš ï¸  Cambios sin commitear:"
                        has_uncommitted=true
                    fi
                    change_count=$(git status -s | wc -l)
                    echo "      â€¢ $repo_rel_path ($change_count archivos)"
                fi
            fi
        fi
    done

    # Mostrar repos con commits pendientes de push
    has_unpushed=false
    echo "$repos" | while read -r repo_rel_path; do
        if [ -n "$repo_rel_path" ]; then
            worktree_path="$path/$repo_rel_path"
            if [ -d "$worktree_path" ]; then
                cd "$worktree_path"

                # Verificar si la branch tiene upstream configurado
                if git rev-parse --abbrev-ref @{u} >/dev/null 2>&1; then
                    # Hay upstream: contar commits pendientes de push
                    unpushed_count=$(git rev-list @{u}..HEAD 2>/dev/null | wc -l | tr -d ' ')
                    if [ -n "$unpushed_count" ] && [ "$unpushed_count" -gt 0 ]; then
                        if [ "$has_unpushed" = false ]; then
                            echo "   ğŸ“¤ Cambios sin push:"
                            has_unpushed=true
                        fi
                        echo "      â€¢ $repo_rel_path ($unpushed_count commits)"
                    fi
                else
                    # No hay upstream: contar todos los commits en la branch
                    local_count=$(git rev-list HEAD 2>/dev/null | wc -l | tr -d ' ')
                    if [ -n "$local_count" ] && [ "$local_count" -gt 0 ]; then
                        if [ "$has_unpushed" = false ]; then
                            echo "   ğŸ“¤ Cambios sin push:"
                            has_unpushed=true
                        fi
                        echo "      â€¢ $repo_rel_path ($local_count commits, sin remoto)"
                    fi
                fi
            fi
        fi
    done

    echo ""
}

# Contar workspaces
workspace_count=0

# Listar todos los workspaces (master, develop y cualquier otro)
if [ -d "$WORKSPACES_DIR" ]; then
    for workspace_dir in "$WORKSPACES_DIR"/*; do
        if [ -d "$workspace_dir" ]; then
            workspace_name=$(basename "$workspace_dir")
            ((workspace_count++))
            show_workspace "$workspace_name" "$workspace_dir"
        fi
    done
fi

if [ $workspace_count -eq 0 ]; then
    echo "  (No hay workspaces activos)"
    echo ""
    echo "ğŸ’¡ Usa 'ws new <nombre> [repos...]' para crear uno"
    echo ""
else
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "Total: $workspace_count workspaces"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "ğŸ’¡ Usa 'ws switch <nombre>' para ver detalle de un workspace"
fi
