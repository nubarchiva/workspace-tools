#!/bin/bash
# Crea un nuevo workspace
# Soporta repos en subdirectorios (ej: libs/marc4j, modules/docs, tools/workspace-tools)

# Inicializacion centralizada
source "$(dirname "${BASH_SOURCE[0]:-$0}")/ws-init.sh"

# =============================================================================
# Parsear argumentos
# =============================================================================

WORKSPACE_NAME=""
TEMPLATE_NAME=""
REPOS=()

while [[ $# -gt 0 ]]; do
    case "$1" in
        --template|-t)
            TEMPLATE_NAME="$2"
            shift 2
            ;;
        --help|-h)
            WORKSPACE_NAME=""
            break
            ;;
        *)
            if [ -z "$WORKSPACE_NAME" ]; then
                WORKSPACE_NAME="$1"
            else
                REPOS+=("$1")
            fi
            shift
            ;;
    esac
done

# Funcion de ayuda
show_help() {
    echo "Uso: ws new <nombre> [opciones] [repo1 repo2 ...]"
    echo ""
    echo "Opciones:"
    echo "  --template, -t <nombre>  Usar template predefinido de repos"
    echo "  --help, -h               Mostrar esta ayuda"
    echo ""
    echo "Nombres especiales:"
    echo "  master               - Crea workspace de master (branch: master)"
    echo "  develop              - Crea workspace de develop (branch: develop)"
    echo "  <cualquier-otro>     - Crea workspace para feature (branch: feature/<nombre>)"
    echo ""
    echo "Repos:"
    echo "  Especifica repos con su ruta relativa desde $WORKSPACE_ROOT"
    echo "  Ejemplos: ks-nuba, libs/marc4j, modules/docs, tools/workspace-tools"
    echo ""
    echo "Ejemplos:"
    echo "  ws new nuba-8400 ks-nuba dga-commons"
    echo "  ws new faceted-search ks-nuba libs/marc4j"
    echo "  ws new master ks-nuba libs/dspace"
    echo "  ws new develop ks-nuba"
    echo ""
    echo "Con templates:"
    echo "  ws new feature-123 --template frontend"
    echo "  ws new feature-123 -t backend libs/extra   # template + repos extra"
    echo ""
    echo "üí° Si no especificas repos ni template, se crea el directorio vac√≠o"
    echo "   Luego puedes a√±adir repos con: ws add <nombre> <repo>"
    echo ""
    echo "Gesti√≥n de templates:"
    echo "  ws templates                    # Lista templates disponibles"
    echo "  ws templates add <nombre> ...   # Crear template"
}

if [ -z "$WORKSPACE_NAME" ]; then
    show_help
    exit 1
fi

# Validar nombre del workspace
if ! validate_workspace_name "$WORKSPACE_NAME"; then
    exit 1
fi

# Si hay template, obtener sus repos
if [ -n "$TEMPLATE_NAME" ]; then
    SCRIPT_DIR="$(dirname "${BASH_SOURCE[0]:-$0}")"
    TEMPLATE_REPOS=$("$SCRIPT_DIR/ws-templates" --get "$TEMPLATE_NAME" 2>/dev/null)

    if [ $? -ne 0 ] || [ -z "$TEMPLATE_REPOS" ]; then
        error "‚ùå Template '$TEMPLATE_NAME' no encontrado"
        echo ""
        echo "Templates disponibles:"
        "$SCRIPT_DIR/ws-templates" list
        exit 1
    fi

    # Convertir repos del template a array y a√±adir al principio
    read -ra TEMPLATE_REPOS_ARRAY <<< "$TEMPLATE_REPOS"

    # Combinar: template repos + repos especificados manualmente (sin duplicados)
    declare -A seen_repos
    COMBINED_REPOS=()

    for repo in "${TEMPLATE_REPOS_ARRAY[@]}"; do
        if [ -z "${seen_repos[$repo]}" ]; then
            COMBINED_REPOS+=("$repo")
            seen_repos[$repo]=1
        fi
    done

    for repo in "${REPOS[@]}"; do
        if [ -z "${seen_repos[$repo]}" ]; then
            COMBINED_REPOS+=("$repo")
            seen_repos[$repo]=1
        fi
    done

    REPOS=("${COMBINED_REPOS[@]}")
    info "üìã Usando template: ${COLOR_CYAN}$TEMPLATE_NAME${COLOR_RESET}"
fi

# Determinar directorio y branch
WORKSPACE_DIR="$WORKSPACES_DIR/$WORKSPACE_NAME"
BRANCH_NAME="$(get_branch_name "$WORKSPACE_NAME")"

# Verificar si el workspace ya existe
if [ -d "$WORKSPACE_DIR" ]; then
    warning "‚ö†Ô∏è  El workspace ya existe: $WORKSPACE_DIR"
    read -p "¬øQuieres a√±adir repos al workspace existente? (s/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Ss]$ ]]; then
        exit 1
    fi
fi

# Crear directorio del workspace
mkdir -p "$WORKSPACE_DIR"

info "üî® Creando workspace: ${COLOR_BOLD}$WORKSPACE_NAME${COLOR_RESET} (branch: ${COLOR_CYAN}$BRANCH_NAME${COLOR_RESET})"

# Si no hay repos especificados, solo crear el directorio
if [ ${#REPOS[@]} -eq 0 ]; then
    success "üìÅ Directorio creado: $WORKSPACE_DIR"
    info "üí° A√±ade repos con: ws add $WORKSPACE_NAME <repo>"

    # Copiar configuraciones de IDE y AI assistants
    copy_workspace_config "$WORKSPACE_DIR"

    echo ""
    success "‚úÖ Workspace creado: $WORKSPACE_DIR"
    exit 0
fi

echo "${COLOR_DIM}Repos a incluir: ${REPOS[@]}${COLOR_RESET}"
echo ""

# Crear worktree para cada repo
for repo in "${REPOS[@]}"; do
    # El repo puede estar en subdirectorio (ej: libs/marc4j, tools/workspace-tools)
    REPO_PATH="$WORKSPACE_ROOT/$repo"
    WORKTREE_PATH="$WORKSPACE_DIR/$repo"

    if [ ! -d "$REPO_PATH/.git" ]; then
        warning "‚ö†Ô∏è  Repo $repo no encontrado en $REPO_PATH (saltando)"
        continue
    fi

    echo "üìÅ Procesando ${COLOR_CYAN}$repo${COLOR_RESET}..."

    # Crear estructura de subdirectorios si es necesario
    WORKTREE_PARENT=$(dirname "$WORKTREE_PATH")
    mkdir -p "$WORKTREE_PARENT"

    cd "$REPO_PATH"

    # Para master/develop, usar la branch existente
    # Para features, crear branch nueva si no existe
    if [ "$WORKSPACE_NAME" != "master" ] && [ "$WORKSPACE_NAME" != "develop" ]; then
        if ! git rev-parse --verify "$BRANCH_NAME" >/dev/null 2>&1; then
            echo "  ${COLOR_DIM}‚ûï Creando branch: $BRANCH_NAME${COLOR_RESET}"
            if ! git branch "$BRANCH_NAME" 2>&1; then
                error "  ‚ùå Error al crear branch $BRANCH_NAME"
                continue
            fi
        fi
    fi

    # Crear worktree
    if [ -d "$WORKTREE_PATH" ]; then
        warning "  ‚ö†Ô∏è  Worktree ya existe, saltando"
    else
        if git worktree add "$WORKTREE_PATH" "$BRANCH_NAME" 2>&1; then
            success "  ‚úÖ Worktree creado en branch: $BRANCH_NAME"
        else
            error "  ‚ùå Error al crear worktree"
            info "  üí° Verifica que la branch no est√© siendo usada por otro worktree"
        fi
    fi
done

# Copiar configuraciones de IDE y AI assistants
copy_workspace_config "$WORKSPACE_DIR"

echo ""
success "‚úÖ Workspace creado: $WORKSPACE_DIR"
echo ""
echo "Para trabajar:"
echo "  ${COLOR_CYAN}cd $WORKSPACE_DIR${COLOR_RESET}"
