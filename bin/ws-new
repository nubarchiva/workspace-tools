#!/bin/bash
# Crea un nuevo workspace
# Soporta repos en subdirectorios (ej: libs/marc4j, modules/docs, tools/workspace-tools)

WORKSPACE_NAME=$1
shift 2>/dev/null || true
REPOS=("$@")

# Detectar WORKSPACE_ROOT desde WS_TOOLS o por defecto
if [ -n "$WS_TOOLS" ]; then
    WORKSPACE_ROOT="${WS_TOOLS%/tools/workspace-tools}"
else
    # Fallback: asumir ubicaci√≥n est√°ndar
    WORKSPACE_ROOT=~/wrkspc.nubarchiva
fi
WORKSPACES_DIR=$WORKSPACE_ROOT/workspaces

# Detectar directorio del script (compatible bash/zsh)
if [ -n "$BASH_SOURCE" ]; then
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
else
    SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
fi

# Cargar funciones compartidas
source "$SCRIPT_DIR/ws-common.sh"
source "$SCRIPT_DIR/ws-colors.sh"

# Funci√≥n de ayuda
show_help() {
    echo "Uso: ws new <nombre> [repo1 repo2 ...]"
    echo ""
    echo "Nombres especiales:"
    echo "  master               - Crea workspace de master (branch: master)"
    echo "  develop              - Crea workspace de develop (branch: develop)"
    echo "  <cualquier-otro>     - Crea workspace para feature (branch: feature/<nombre>)"
    echo ""
    echo "Repos:"
    echo "  Especifica repos con su ruta relativa desde $WORKSPACE_ROOT"
    echo "  Ejemplos: ks-nuba, libs/marc4j, modules/docs, tools/workspace-tools"
    echo ""
    echo "Ejemplos:"
    echo "  ws new nuba-8400 ks-nuba dga-commons"
    echo "  ws new faceted-search ks-nuba libs/marc4j"
    echo "  ws new master ks-nuba libs/dspace"
    echo "  ws new develop ks-nuba"
    echo ""
    echo "üí° Si no especificas repos, se crea el directorio vac√≠o"
    echo "   Luego puedes a√±adir repos con: ws add <nombre> <repo>"
}

if [ -z "$WORKSPACE_NAME" ]; then
    show_help
    exit 1
fi

# Determinar directorio y branch
WORKSPACE_DIR=$WORKSPACES_DIR/$WORKSPACE_NAME
BRANCH_NAME=$(get_branch_name "$WORKSPACE_NAME")

# Verificar si el workspace ya existe
if [ -d "$WORKSPACE_DIR" ]; then
    warning "‚ö†Ô∏è  El workspace ya existe: $WORKSPACE_DIR"
    read -p "¬øQuieres a√±adir repos al workspace existente? (s/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Ss]$ ]]; then
        exit 1
    fi
fi

# Crear directorio del workspace
mkdir -p $WORKSPACE_DIR

info "üî® Creando workspace: ${COLOR_BOLD}$WORKSPACE_NAME${COLOR_RESET} (branch: ${COLOR_CYAN}$BRANCH_NAME${COLOR_RESET})"

# Si no hay repos especificados, solo crear el directorio
if [ ${#REPOS[@]} -eq 0 ]; then
    success "üìÅ Directorio creado: $WORKSPACE_DIR"
    info "üí° A√±ade repos con: ws add $WORKSPACE_NAME <repo>"

    # Copiar configuraciones de IDE y AI assistants
    copy_workspace_config "$WORKSPACE_DIR"

    echo ""
    success "‚úÖ Workspace creado: $WORKSPACE_DIR"
    exit 0
fi

echo "${COLOR_DIM}Repos a incluir: ${REPOS[@]}${COLOR_RESET}"
echo ""

# Crear worktree para cada repo
for repo in "${REPOS[@]}"; do
    # El repo puede estar en subdirectorio (ej: libs/marc4j, tools/workspace-tools)
    REPO_PATH=$WORKSPACE_ROOT/$repo
    WORKTREE_PATH=$WORKSPACE_DIR/$repo

    if [ ! -d "$REPO_PATH/.git" ]; then
        warning "‚ö†Ô∏è  Repo $repo no encontrado en $REPO_PATH (saltando)"
        continue
    fi

    echo "üìÅ Procesando ${COLOR_CYAN}$repo${COLOR_RESET}..."

    # Crear estructura de subdirectorios si es necesario
    WORKTREE_PARENT=$(dirname "$WORKTREE_PATH")
    mkdir -p "$WORKTREE_PARENT"

    cd "$REPO_PATH"

    # Para master/develop, usar la branch existente
    # Para features, crear branch nueva si no existe
    if [ "$WORKSPACE_NAME" != "master" ] && [ "$WORKSPACE_NAME" != "develop" ]; then
        if ! git rev-parse --verify "$BRANCH_NAME" >/dev/null 2>&1; then
            echo "  ${COLOR_DIM}‚ûï Creando branch: $BRANCH_NAME${COLOR_RESET}"
            if ! git branch "$BRANCH_NAME" 2>&1; then
                error "  ‚ùå Error al crear branch $BRANCH_NAME"
                continue
            fi
        fi
    fi

    # Crear worktree
    if [ -d "$WORKTREE_PATH" ]; then
        warning "  ‚ö†Ô∏è  Worktree ya existe, saltando"
    else
        if git worktree add "$WORKTREE_PATH" "$BRANCH_NAME" 2>&1; then
            success "  ‚úÖ Worktree creado en branch: $BRANCH_NAME"
        else
            error "  ‚ùå Error al crear worktree"
            info "  üí° Verifica que la branch no est√© siendo usada por otro worktree"
        fi
    fi
done

# Generar .ws-build-order con el orden de repos especificado
if [ ${#REPOS[@]} -gt 0 ]; then
    BUILD_ORDER_FILE="$WORKSPACE_DIR/.ws-build-order"
    echo "# Orden de compilaci√≥n para workspace: $WORKSPACE_NAME" > "$BUILD_ORDER_FILE"
    echo "# Generado autom√°ticamente - puedes modificar el orden" >> "$BUILD_ORDER_FILE"
    for repo in "${REPOS[@]}"; do
        echo "$repo" >> "$BUILD_ORDER_FILE"
    done
fi

# Copiar configuraciones de IDE y AI assistants
copy_workspace_config "$WORKSPACE_DIR"

echo ""
success "‚úÖ Workspace creado: $WORKSPACE_DIR"
echo ""
echo "Para trabajar:"
echo "  ${COLOR_CYAN}cd $WORKSPACE_DIR${COLOR_RESET}"
