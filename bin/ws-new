#!/bin/bash
# Crea un nuevo workspace (feature, master, develop, etc.)
# Soporta repos en subdirectorios (ej: libs/marc4j, modules/docs, tools/workspace-tools)

set -e

WORKSPACE_TYPE=$1  # feature, master, develop
WORKSPACE_NAME=$2
shift 2 2>/dev/null || true
REPOS=("$@")

# Detectar WORKSPACE_ROOT autom√°ticamente (2 niveles arriba del script)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WORKSPACE_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
WORKSPACES_DIR=$WORKSPACE_ROOT/workspaces

# Funci√≥n de ayuda
show_help() {
    echo "Uso: ws-new <tipo> <nombre> [repo1 repo2 ...]"
    echo ""
    echo "Tipos de workspace:"
    echo "  feature <nombre> [repos...]  - Crea workspace para una feature"
    echo "  master [repos...]            - Crea workspace de master"
    echo "  develop [repos...]           - Crea workspace de develop"
    echo ""
    echo "Repos:"
    echo "  Especifica repos con su ruta relativa desde $WORKSPACE_ROOT"
    echo "  Ejemplos: ks-nuba, libs/marc4j, modules/docs, tools/workspace-tools"
    echo ""
    echo "Ejemplos:"
    echo "  ws-new feature faceted-search ks-nuba dga-commons"
    echo "  ws-new feature marc-upgrade ks-nuba libs/marc4j"
    echo "  ws-new feature full ks-nuba libs/marc4j modules/docs"
    echo "  ws-new master ks-nuba libs/dspace"
    echo "  ws-new develop"
    echo ""
    echo "üí° Si no especificas repos, se crea el directorio vac√≠o"
    echo "   Luego puedes a√±adir repos con: ws-add"
}

if [ -z "$WORKSPACE_TYPE" ]; then
    show_help
    exit 1
fi

# Determinar directorio y branch seg√∫n tipo
case $WORKSPACE_TYPE in
    feature)
        if [ -z "$WORKSPACE_NAME" ]; then
            echo "‚ùå Las features requieren un nombre"
            show_help
            exit 1
        fi
        WORKSPACE_DIR=$WORKSPACES_DIR/features/$WORKSPACE_NAME
        BRANCH_PREFIX="feature/$WORKSPACE_NAME"
        ;;
    master)
        WORKSPACE_DIR=$WORKSPACES_DIR/master
        BRANCH_PREFIX="master"
        WORKSPACE_NAME="master"
        ;;
    develop)
        WORKSPACE_DIR=$WORKSPACES_DIR/develop
        BRANCH_PREFIX="develop"
        WORKSPACE_NAME="develop"
        ;;
    *)
        echo "‚ùå Tipo de workspace inv√°lido: $WORKSPACE_TYPE"
        show_help
        exit 1
        ;;
esac

# Verificar si el workspace ya existe
if [ -d "$WORKSPACE_DIR" ]; then
    echo "‚ö†Ô∏è  El workspace ya existe: $WORKSPACE_DIR"
    read -p "¬øQuieres a√±adir repos al workspace existente? (s/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Ss]$ ]]; then
        exit 1
    fi
fi

# Crear directorio del workspace
mkdir -p $WORKSPACE_DIR

echo "üî® Creando workspace: $WORKSPACE_TYPE/$WORKSPACE_NAME"

# Si no hay repos especificados, solo crear el directorio
if [ ${#REPOS[@]} -eq 0 ]; then
    echo "üìÅ Directorio creado: $WORKSPACE_DIR"
    echo "üí° A√±ade repos con: ws-add $WORKSPACE_TYPE $WORKSPACE_NAME <repo>"
    
    # Crear README si no existe
    if [ ! -f "$WORKSPACE_DIR/README.md" ]; then
        cat > $WORKSPACE_DIR/README.md <<EOF
# Workspace: $WORKSPACE_NAME

## Tipo
$WORKSPACE_TYPE

## Repos
(Ninguno todav√≠a - usa ws-add para a√±adir)

## Notas
[A√±ade informaci√≥n de contexto aqu√≠]
EOF
    fi
    exit 0
fi

echo "Repos a incluir: ${REPOS[@]}"
echo ""

# Crear worktree para cada repo
for repo in "${REPOS[@]}"; do
    # El repo puede estar en subdirectorio (ej: libs/marc4j, tools/workspace-tools)
    REPO_PATH=$WORKSPACE_ROOT/$repo
    WORKTREE_PATH=$WORKSPACE_DIR/$repo
    
    if [ ! -d "$REPO_PATH/.git" ]; then
        echo "‚ö†Ô∏è  Repo $repo no encontrado en $REPO_PATH (saltando)"
        continue
    fi
    
    echo "üìÅ Procesando $repo..."
    
    # Crear estructura de subdirectorios si es necesario
    WORKTREE_PARENT=$(dirname "$WORKTREE_PATH")
    mkdir -p "$WORKTREE_PARENT"
    
    cd $REPO_PATH
    
    # Determinar nombre de branch
    BRANCH_NAME=$BRANCH_PREFIX
    
    # Para master/develop, usar la branch existente
    # Para features, crear branch nueva si no existe
    if [ "$WORKSPACE_TYPE" = "feature" ]; then
        git rev-parse --verify $BRANCH_NAME >/dev/null 2>&1
        if [ $? -ne 0 ]; then
            echo "  ‚ûï Creando branch: $BRANCH_NAME"
            git branch $BRANCH_NAME
        fi
    fi
    
    # Crear worktree
    if [ -d "$WORKTREE_PATH" ]; then
        echo "  ‚ö†Ô∏è  Worktree ya existe, saltando"
    else
        git worktree add $WORKTREE_PATH $BRANCH_NAME
        echo "  ‚úÖ Worktree creado en branch: $BRANCH_NAME"
    fi
done

# Crear archivo de contexto
cat > $WORKSPACE_DIR/README.md <<EOF
# Workspace: $WORKSPACE_NAME

## Tipo
$WORKSPACE_TYPE

## Repos involucrados
$(for repo in "${REPOS[@]}"; do echo "- \`$repo\` ‚Üí branch: $BRANCH_PREFIX"; done)

## Descripci√≥n
$(if [ "$WORKSPACE_TYPE" = "feature" ]; then
    echo "[Describe aqu√≠ el objetivo de esta feature]"
else
    echo "Workspace para trabajo en $WORKSPACE_TYPE"
fi)

## Notas para AI
[Contexto relevante para herramientas de AI]

$(if [ "$WORKSPACE_TYPE" = "feature" ]; then
cat <<CHECKLIST
## Checklist
- [ ] Cambios implementados
- [ ] Tests actualizados
- [ ] Documentaci√≥n actualizada
- [ ] Revisi√≥n de dependencias
- [ ] PR creado
CHECKLIST
fi)

## Creado
$(date)
EOF

echo ""
echo "‚úÖ Workspace creado: $WORKSPACE_DIR"
echo "üìù Edita $WORKSPACE_DIR/README.md para documentar"
echo ""
echo "Para trabajar:"
echo "  cd $WORKSPACE_DIR"
