#!/bin/bash
# Crea un nuevo workspace
# Soporta repos en subdirectorios (ej: libs/marc4j, modules/docs, tools/workspace-tools)

set -e

WORKSPACE_NAME=$1
shift 2>/dev/null || true
REPOS=("$@")

# Detectar WORKSPACE_ROOT desde WS_TOOLS o por defecto
if [ -n "$WS_TOOLS" ]; then
    WORKSPACE_ROOT="${WS_TOOLS%/tools/workspace-tools}"
else
    # Fallback: asumir ubicaci√≥n est√°ndar
    WORKSPACE_ROOT=~/wrkspc.nubarchiva
fi
WORKSPACES_DIR=$WORKSPACE_ROOT/workspaces

# Detectar directorio del script (compatible bash/zsh)
if [ -n "$BASH_SOURCE" ]; then
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
else
    SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
fi

# Cargar funciones compartidas
source "$SCRIPT_DIR/ws-common.sh"

# Funci√≥n de ayuda
show_help() {
    echo "Uso: ws new <nombre> [repo1 repo2 ...]"
    echo ""
    echo "Nombres especiales:"
    echo "  master               - Crea workspace de master (branch: master)"
    echo "  develop              - Crea workspace de develop (branch: develop)"
    echo "  <cualquier-otro>     - Crea workspace para feature (branch: feature/<nombre>)"
    echo ""
    echo "Repos:"
    echo "  Especifica repos con su ruta relativa desde $WORKSPACE_ROOT"
    echo "  Ejemplos: ks-nuba, libs/marc4j, modules/docs, tools/workspace-tools"
    echo ""
    echo "Ejemplos:"
    echo "  ws new nuba-8400 ks-nuba dga-commons"
    echo "  ws new faceted-search ks-nuba libs/marc4j"
    echo "  ws new master ks-nuba libs/dspace"
    echo "  ws new develop ks-nuba"
    echo ""
    echo "üí° Si no especificas repos, se crea el directorio vac√≠o"
    echo "   Luego puedes a√±adir repos con: ws add <nombre> <repo>"
}

if [ -z "$WORKSPACE_NAME" ]; then
    show_help
    exit 1
fi

# Determinar directorio y branch
WORKSPACE_DIR=$WORKSPACES_DIR/$WORKSPACE_NAME
BRANCH_NAME=$(get_branch_name "$WORKSPACE_NAME")

# Verificar si el workspace ya existe
if [ -d "$WORKSPACE_DIR" ]; then
    echo "‚ö†Ô∏è  El workspace ya existe: $WORKSPACE_DIR"
    read -p "¬øQuieres a√±adir repos al workspace existente? (s/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Ss]$ ]]; then
        exit 1
    fi
fi

# Crear directorio del workspace
mkdir -p $WORKSPACE_DIR

echo "üî® Creando workspace: $WORKSPACE_NAME (branch: $BRANCH_NAME)"

# Si no hay repos especificados, solo crear el directorio
if [ ${#REPOS[@]} -eq 0 ]; then
    echo "üìÅ Directorio creado: $WORKSPACE_DIR"
    echo "üí° A√±ade repos con: ws add $WORKSPACE_NAME <repo>"

    # Crear README si no existe
    if [ ! -f "$WORKSPACE_DIR/README.md" ]; then
        cat > $WORKSPACE_DIR/README.md <<EOF
# Workspace: $WORKSPACE_NAME

## Branch
$BRANCH_NAME

## Repos
(Ninguno todav√≠a - usa ws add para a√±adir)

## Notas
[A√±ade informaci√≥n de contexto aqu√≠]
EOF
    fi
    exit 0
fi

echo "Repos a incluir: ${REPOS[@]}"
echo ""

# Crear worktree para cada repo
for repo in "${REPOS[@]}"; do
    # El repo puede estar en subdirectorio (ej: libs/marc4j, tools/workspace-tools)
    REPO_PATH=$WORKSPACE_ROOT/$repo
    WORKTREE_PATH=$WORKSPACE_DIR/$repo

    if [ ! -d "$REPO_PATH/.git" ]; then
        echo "‚ö†Ô∏è  Repo $repo no encontrado en $REPO_PATH (saltando)"
        continue
    fi

    echo "üìÅ Procesando $repo..."

    # Crear estructura de subdirectorios si es necesario
    WORKTREE_PARENT=$(dirname "$WORKTREE_PATH")
    mkdir -p "$WORKTREE_PARENT"

    cd $REPO_PATH

    # Para master/develop, usar la branch existente
    # Para features, crear branch nueva si no existe
    if [ "$WORKSPACE_NAME" != "master" ] && [ "$WORKSPACE_NAME" != "develop" ]; then
        git rev-parse --verify $BRANCH_NAME >/dev/null 2>&1
        if [ $? -ne 0 ]; then
            echo "  ‚ûï Creando branch: $BRANCH_NAME"
            git branch $BRANCH_NAME
        fi
    fi

    # Crear worktree
    if [ -d "$WORKTREE_PATH" ]; then
        echo "  ‚ö†Ô∏è  Worktree ya existe, saltando"
    else
        git worktree add $WORKTREE_PATH $BRANCH_NAME
        echo "  ‚úÖ Worktree creado en branch: $BRANCH_NAME"
    fi
done

# Crear archivo de contexto
cat > $WORKSPACE_DIR/README.md <<EOF
# Workspace: $WORKSPACE_NAME

## Branch
$BRANCH_NAME

## Repos involucrados
$(for repo in "${REPOS[@]}"; do echo "- \`$repo\` ‚Üí branch: $BRANCH_NAME"; done)

## Descripci√≥n
$(if [ "$WORKSPACE_NAME" != "master" ] && [ "$WORKSPACE_NAME" != "develop" ]; then
    echo "[Describe aqu√≠ el objetivo de esta feature/tarea]"
else
    echo "Workspace para trabajo en $WORKSPACE_NAME"
fi)

## Notas para AI
[Contexto relevante para herramientas de AI]

$(if [ "$WORKSPACE_NAME" != "master" ] && [ "$WORKSPACE_NAME" != "develop" ]; then
cat <<CHECKLIST
## Checklist
- [ ] Cambios implementados
- [ ] Tests actualizados
- [ ] Documentaci√≥n actualizada
- [ ] Revisi√≥n de dependencias
- [ ] PR creado
CHECKLIST
fi)

## Creado
$(date)
EOF

echo ""
echo "‚úÖ Workspace creado: $WORKSPACE_DIR"
echo "üìù Edita $WORKSPACE_DIR/README.md para documentar"
echo ""
echo "Para trabajar:"
echo "  cd $WORKSPACE_DIR"
