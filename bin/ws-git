#!/bin/bash
# Ejecuta comandos Git en todos los repos de un workspace

# Inicializacion centralizada
source "$(dirname "${BASH_SOURCE[0]:-$0}")/ws-init.sh"

# Determinar workspace y argumentos
# Prioridad: 1) Workspace expl√≠cito si $1 coincide con uno existente
#            2) Auto-detecci√≥n si estamos dentro de un workspace
#            3) Modo tradicional (primer arg es workspace)
WORKSPACE_PATTERN=""
GIT_ARGS=""

if [[ -n "$1" ]]; then
    if is_workspace_pattern "$1"; then
        # Primer argumento coincide con workspace ‚Üí modo expl√≠cito
        WORKSPACE_PATTERN="$1"
        shift
        GIT_ARGS="$@"
    else
        # Primer argumento NO es workspace ‚Üí intentar auto-detecci√≥n
        DETECTED_WORKSPACE=$(detect_current_workspace 2>/dev/null || true)
        if [[ -n "$DETECTED_WORKSPACE" ]]; then
            # Auto-detectado, todos los args son para Git
            WORKSPACE_PATTERN="$DETECTED_WORKSPACE"
            GIT_ARGS="$@"
        else
            # No auto-detectado, asumir modo tradicional
            WORKSPACE_PATTERN="$1"
            shift
            GIT_ARGS="$@"
        fi
    fi
else
    # Sin argumentos, intentar auto-detecci√≥n
    DETECTED_WORKSPACE=$(detect_current_workspace 2>/dev/null || true)
    if [[ -n "$DETECTED_WORKSPACE" ]]; then
        WORKSPACE_PATTERN="$DETECTED_WORKSPACE"
        GIT_ARGS="$@"
    fi
fi

# Funci√≥n de ayuda
show_help() {
    echo "Uso: ws git <nombre|patr√≥n> <comando-git> [argumentos...]"
    echo ""
    echo "Ejecuta comandos Git en todos los repos de un workspace."
    echo ""
    echo "üí° Puedes usar coincidencia parcial para el nombre del workspace"
    echo ""
    echo "Ejemplos:"
    echo "  ws git nuba-8400 status"
    echo "  ws git master pull"
    echo "  ws git fac log --oneline -5"
    echo "  ws git 8089 fetch"
    echo ""
    echo "Comportamiento:"
    echo "  ‚Ä¢ Ejecuta 'git <args>' en cada repo del workspace"
    echo "  ‚Ä¢ Se detiene en el primer error"
    echo "  ‚Ä¢ Ignora directorios sin .git"
}

# Validar que hay comando Git
if [[ -z "$GIT_ARGS" ]]; then
    error "‚ùå Error: debes especificar un comando para Git"
    echo ""
    show_help
    exit 1
fi

# Resolver workspace (usa WORKSPACE_PATTERN, define WORKSPACE_NAME y WORKSPACE_DIR)
resolve_workspace "$WORKSPACE_PATTERN" "ws git <workspace> <comando-git>"
BRANCH_NAME="$(get_branch_name "$WORKSPACE_NAME")"

print_header "Ejecutando Git en workspace"
echo ""
echo "Workspace: ${COLOR_CYAN}$WORKSPACE_NAME${COLOR_RESET}"
echo "Branch:    ${COLOR_CYAN}$BRANCH_NAME${COLOR_RESET}"
echo "Comando:   ${COLOR_BOLD}git $GIT_ARGS${COLOR_RESET}"
echo ""

# Encontrar todos los repos en el workspace
repos=$(find_repos_in_workspace "$WORKSPACE_DIR")

if [ -z "$repos" ] || [ "$repos" = "" ]; then
    die "No hay repos en este workspace"
fi

# Ejecutar Git en cada repo
echo "$repos" | while read -r repo_rel_path; do
    if [ -n "$repo_rel_path" ]; then
        repo_path="$WORKSPACE_DIR/$repo_rel_path"

        if [ -d "$repo_path/.git" ] || [ -f "$repo_path/.git" ]; then
            print_separator_with_title "${COLOR_CYAN}$repo_rel_path${COLOR_RESET}"
            echo ""

            # Cambiar al directorio del repo y ejecutar Git
            cd "$repo_path"

            # Detectar si es "push" y manejar casos especiales
            ACTUAL_GIT_ARGS="$GIT_ARGS"
            SKIP_PUSH=false

            if [[ "$GIT_ARGS" == "push"* ]]; then
                current_branch=$(git branch --show-current)

                # Verificar si hay upstream configurado
                if ! git rev-parse --abbrev-ref @{u} >/dev/null 2>&1; then
                    # Sin upstream: verificar si hay commits locales que subir
                    # Comparamos con la branch base (develop o master)
                    base_branch="develop"
                    if ! git rev-parse --verify "$base_branch" >/dev/null 2>&1; then
                        base_branch="master"
                    fi

                    # Contar commits en la branch actual que no est√°n en base
                    commits_ahead=$(git rev-list --count "$base_branch..$current_branch" 2>/dev/null || echo "0")

                    if [ "$commits_ahead" -eq 0 ]; then
                        echo "   ${COLOR_DIM}‚è≠Ô∏è  Sin commits nuevos, omitiendo push (no se crea branch remota vac√≠a)${COLOR_RESET}"
                        SKIP_PUSH=true
                    else
                        info "   üì§ Sin upstream ($commits_ahead commits), ejecutando: git push -u origin $current_branch"
                        ACTUAL_GIT_ARGS="push -u origin $current_branch"
                    fi
                fi
            fi

            if [ "$SKIP_PUSH" = false ]; then
                git $ACTUAL_GIT_ARGS
            fi

            # Verificar el resultado
            exit_code=$?
            if [ $exit_code -ne 0 ]; then
                echo ""
                error "‚ùå Error en $repo_rel_path (exit code: $exit_code)"
                error "   Deteniendo ejecuci√≥n"
                exit $exit_code
            fi

            echo ""
        fi
    fi
done

# Capturar el exit code del while loop
exit_code=$?

if [ $exit_code -ne 0 ]; then
    exit $exit_code
fi

success "‚úÖ Git ejecutado correctamente en todos los repos"
