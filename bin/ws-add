#!/bin/bash
# A√±ade uno o m√°s repos a un workspace existente
# Soporta repos en subdirectorios (ej: libs/marc4j, modules/docs, tools/*)

# Detectar directorio del script (compatible bash/zsh)
if [ -n "$BASH_SOURCE" ]; then
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
else
    SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
fi

# Cargar funciones compartidas ANTES de usarlas
source "$SCRIPT_DIR/ws-common.sh"
source "$SCRIPT_DIR/ws-colors.sh"

# Determinar workspace y repos
# Prioridad: 1) Workspace expl√≠cito si $1 coincide con uno existente
#            2) Auto-detecci√≥n si estamos dentro de un workspace
#            3) Modo tradicional (primer arg es workspace)
WORKSPACE_PATTERN=""
REPOS=()

if [ -n "$1" ]; then
    # Verificar si primer argumento corresponde a un workspace existente
    first_arg_lower=$(echo "$1" | tr '[:upper:]' '[:lower:]')
    is_workspace=false

    if [ -d "$WORKSPACES_DIR" ]; then
        for ws_dir in "$WORKSPACES_DIR"/*; do
            if [ -d "$ws_dir" ]; then
                ws_name=$(basename "$ws_dir")
                ws_name_lower=$(echo "$ws_name" | tr '[:upper:]' '[:lower:]')
                if [[ "$ws_name_lower" == *"$first_arg_lower"* ]]; then
                    is_workspace=true
                    break
                fi
            fi
        done
    fi

    if [ "$is_workspace" = true ]; then
        # Primer argumento coincide con workspace ‚Üí modo expl√≠cito
        WORKSPACE_PATTERN="$1"
        shift
        REPOS=("$@")
    else
        # Primer argumento NO es workspace ‚Üí intentar auto-detecci√≥n
        DETECTED_WORKSPACE=$(detect_current_workspace 2>/dev/null || true)
        if [ -n "$DETECTED_WORKSPACE" ]; then
            # Auto-detectado, todos los args son repos
            WORKSPACE_PATTERN="$DETECTED_WORKSPACE"
            REPOS=("$@")
        else
            # No auto-detectado, asumir modo tradicional
            WORKSPACE_PATTERN="$1"
            shift
            REPOS=("$@")
        fi
    fi
else
    # Sin argumentos, intentar auto-detecci√≥n
    DETECTED_WORKSPACE=$(detect_current_workspace 2>/dev/null || true)
    if [ -n "$DETECTED_WORKSPACE" ]; then
        WORKSPACE_PATTERN="$DETECTED_WORKSPACE"
    fi
fi

# Detectar WORKSPACE_ROOT
if [ -n "$WS_TOOLS" ]; then
    WORKSPACE_ROOT="${WS_TOOLS%/tools/workspace-tools}"
else
    WORKSPACE_ROOT=~/wrkspc.nubarchiva
fi
WORKSPACES_DIR=$WORKSPACE_ROOT/workspaces

if [ ${#REPOS[@]} -eq 0 ]; then
    echo "Uso: ws add <nombre|patr√≥n> <repo1> [repo2] [repo3] ..."
    echo ""
    echo "Repos:"
    echo "  Especifica repos con su ruta relativa desde $WORKSPACE_ROOT"
    echo "  Ejemplos: ks-nuba, libs/marc4j, modules/docs, tools/otro-tool"
    echo ""
    echo "üí° Puedes usar coincidencia parcial para el nombre del workspace"
    echo "üí° Puedes a√±adir m√∫ltiples repos a la vez"
    echo ""
    echo "Ejemplos:"
    echo "  ws add nuba-8400 ks-nuba"
    echo "  ws add nuba-8400 ks-nuba dga-commons libs/marc4j    # m√∫ltiples repos"
    echo "  ws add fac libs/marc4j              # b√∫squeda parcial"
    echo "  ws add master libs/dspace"
    echo "  ws add develop modules/metadata-entities"
    exit 1
fi

# Buscar workspace que coincida con el patr√≥n
WORKSPACE_NAME=$(find_matching_workspace "$WORKSPACE_PATTERN" "$WORKSPACES_DIR")
if [ $? -ne 0 ]; then
    exit 1
fi

# Determinar directorio y branch del workspace
WORKSPACE_DIR=$WORKSPACES_DIR/$WORKSPACE_NAME
BRANCH_NAME=$(get_branch_name "$WORKSPACE_NAME")

if [ ! -d "$WORKSPACE_DIR" ]; then
    error "‚ùå Workspace no existe: $WORKSPACE_NAME"
    info "üí° Cr√©alo primero con: ws new $WORKSPACE_NAME"
    exit 1
fi

# Procesar cada repo
for REPO in "${REPOS[@]}"; do
    # El repo puede estar en subdirectorio (ej: libs/marc4j, tools/workspace-tools)
    REPO_PATH=$WORKSPACE_ROOT/$REPO
    WORKTREE_PATH=$WORKSPACE_DIR/$REPO

    if [ ! -d "$REPO_PATH/.git" ]; then
        warning "‚ö†Ô∏è  Repo no encontrado: $REPO_PATH (saltando)"
        info "üí° Aseg√∫rate de usar la ruta correcta (ej: libs/marc4j, tools/mi-tool)"
        continue
    fi

    if [ -d "$WORKTREE_PATH" ]; then
        warning "‚ö†Ô∏è  El repo ya existe en este workspace: $REPO (saltando)"
        continue
    fi

    info "‚ûï A√±adiendo ${COLOR_CYAN}$REPO${COLOR_RESET} a workspace ${COLOR_BOLD}$WORKSPACE_NAME${COLOR_RESET} (branch: ${COLOR_CYAN}$BRANCH_NAME${COLOR_RESET})"

    # Crear estructura de subdirectorios si es necesario
    WORKTREE_PARENT=$(dirname "$WORKTREE_PATH")
    mkdir -p "$WORKTREE_PARENT"

    cd "$REPO_PATH"

    # Para features, crear branch si no existe
    if [ "$WORKSPACE_NAME" != "master" ] && [ "$WORKSPACE_NAME" != "develop" ]; then
        if ! git rev-parse --verify "$BRANCH_NAME" >/dev/null 2>&1; then
            echo "  ${COLOR_DIM}‚ûï Creando branch: $BRANCH_NAME${COLOR_RESET}"
            if ! git branch "$BRANCH_NAME" 2>&1; then
                error "  ‚ùå Error al crear branch $BRANCH_NAME"
                continue
            fi
        fi
    fi

    # Crear worktree
    if git worktree add "$WORKTREE_PATH" "$BRANCH_NAME" 2>&1; then
        success "‚úÖ Repo a√±adido: $WORKTREE_PATH"
        echo "   Branch: ${COLOR_CYAN}$BRANCH_NAME${COLOR_RESET}"
    else
        error "‚ùå Error al a√±adir $REPO"
        info "üí° Verifica que la branch no est√© siendo usada por otro worktree"
    fi

    echo ""
done
