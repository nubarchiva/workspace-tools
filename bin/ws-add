#!/bin/bash
# AÃ±ade un repo a un workspace existente
# Soporta repos en subdirectorios (ej: libs/marc4j, modules/docs, tools/*)

set -e

WORKSPACE_TYPE=$1
WORKSPACE_NAME=$2
REPO=$3

# Detectar WORKSPACE_ROOT automÃ¡ticamente (2 niveles arriba del script)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WORKSPACE_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
WORKSPACES_DIR=$WORKSPACE_ROOT/workspaces

if [ -z "$REPO" ]; then
    echo "Uso: ws-add <tipo> <nombre> <repo>"
    echo ""
    echo "Repos:"
    echo "  Especifica repos con su ruta relativa desde $WORKSPACE_ROOT"
    echo "  Ejemplos: ks-nuba, libs/marc4j, modules/docs, tools/otro-tool"
    echo ""
    echo "Ejemplos:"
    echo "  ws-add feature faceted-search ks-nuba"
    echo "  ws-add feature faceted-search libs/marc4j"
    echo "  ws-add feature faceted-search modules/docs"
    echo "  ws-add master libs/dspace"
    echo "  ws-add develop modules/metadata-entities"
    exit 1
fi

# Determinar directorio del workspace
case $WORKSPACE_TYPE in
    feature)
        WORKSPACE_DIR=$WORKSPACES_DIR/features/$WORKSPACE_NAME
        BRANCH_NAME="feature/$WORKSPACE_NAME"
        ;;
    master)
        WORKSPACE_DIR=$WORKSPACES_DIR/master
        BRANCH_NAME="master"
        ;;
    develop)
        WORKSPACE_DIR=$WORKSPACES_DIR/develop
        BRANCH_NAME="develop"
        ;;
    *)
        echo "âŒ Tipo invÃ¡lido: $WORKSPACE_TYPE"
        exit 1
        ;;
esac

if [ ! -d "$WORKSPACE_DIR" ]; then
    echo "âŒ Workspace no existe: $WORKSPACE_DIR"
    echo "ðŸ’¡ CrÃ©alo primero con: ws-new $WORKSPACE_TYPE $WORKSPACE_NAME"
    exit 1
fi

# El repo puede estar en subdirectorio (ej: libs/marc4j, tools/workspace-tools)
REPO_PATH=$WORKSPACE_ROOT/$REPO
WORKTREE_PATH=$WORKSPACE_DIR/$REPO

if [ ! -d "$REPO_PATH/.git" ]; then
    echo "âŒ Repo no encontrado: $REPO_PATH"
    echo "ðŸ’¡ AsegÃºrate de usar la ruta correcta (ej: libs/marc4j, tools/mi-tool)"
    exit 1
fi

if [ -d "$WORKTREE_PATH" ]; then
    echo "âŒ El repo ya existe en este workspace: $WORKTREE_PATH"
    exit 1
fi

echo "âž• AÃ±adiendo $REPO a workspace $WORKSPACE_TYPE/$WORKSPACE_NAME"

# Crear estructura de subdirectorios si es necesario
WORKTREE_PARENT=$(dirname "$WORKTREE_PATH")
mkdir -p "$WORKTREE_PARENT"

cd $REPO_PATH

# Para features, crear branch si no existe
if [ "$WORKSPACE_TYPE" = "feature" ]; then
    git rev-parse --verify $BRANCH_NAME >/dev/null 2>&1
    if [ $? -ne 0 ]; then
        echo "  âž• Creando branch: $BRANCH_NAME"
        git branch $BRANCH_NAME
    fi
fi

# Crear worktree
git worktree add $WORKTREE_PATH $BRANCH_NAME

echo "âœ… Repo aÃ±adido: $WORKTREE_PATH"
echo "   Branch: $BRANCH_NAME"
