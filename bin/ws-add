#!/bin/bash
# A√±ade un repo a un workspace existente
# Soporta repos en subdirectorios (ej: libs/marc4j, modules/docs, tools/*)

set -e

WORKSPACE_PATTERN=$1
REPO=$2

# Detectar WORKSPACE_ROOT desde WS_TOOLS o por defecto
if [ -n "$WS_TOOLS" ]; then
    WORKSPACE_ROOT="${WS_TOOLS%/tools/workspace-tools}"
else
    # Fallback: asumir ubicaci√≥n est√°ndar
    WORKSPACE_ROOT=~/wrkspc.nubarchiva
fi
WORKSPACES_DIR=$WORKSPACE_ROOT/workspaces
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Cargar funciones compartidas
source "$SCRIPT_DIR/ws-common.sh"

if [ -z "$REPO" ]; then
    echo "Uso: ws add <nombre|patr√≥n> <repo>"
    echo ""
    echo "Repos:"
    echo "  Especifica repos con su ruta relativa desde $WORKSPACE_ROOT"
    echo "  Ejemplos: ks-nuba, libs/marc4j, modules/docs, tools/otro-tool"
    echo ""
    echo "üí° Puedes usar coincidencia parcial para el nombre del workspace"
    echo ""
    echo "Ejemplos:"
    echo "  ws add nuba-8400 ks-nuba"
    echo "  ws add fac libs/marc4j              # busca 'fac' en workspaces"
    echo "  ws add master libs/dspace"
    echo "  ws add develop modules/metadata-entities"
    exit 1
fi

# Buscar workspace que coincida con el patr√≥n
WORKSPACE_NAME=$(find_matching_workspace "$WORKSPACE_PATTERN" "$WORKSPACES_DIR")
if [ $? -ne 0 ]; then
    exit 1
fi

# Determinar directorio y branch del workspace
WORKSPACE_DIR=$WORKSPACES_DIR/$WORKSPACE_NAME
BRANCH_NAME=$(get_branch_name "$WORKSPACE_NAME")

if [ ! -d "$WORKSPACE_DIR" ]; then
    echo "‚ùå Workspace no existe: $WORKSPACE_NAME"
    echo "üí° Cr√©alo primero con: ws new $WORKSPACE_NAME"
    exit 1
fi

# El repo puede estar en subdirectorio (ej: libs/marc4j, tools/workspace-tools)
REPO_PATH=$WORKSPACE_ROOT/$REPO
WORKTREE_PATH=$WORKSPACE_DIR/$REPO

if [ ! -d "$REPO_PATH/.git" ]; then
    echo "‚ùå Repo no encontrado: $REPO_PATH"
    echo "üí° Aseg√∫rate de usar la ruta correcta (ej: libs/marc4j, tools/mi-tool)"
    exit 1
fi

if [ -d "$WORKTREE_PATH" ]; then
    echo "‚ùå El repo ya existe en este workspace: $WORKTREE_PATH"
    exit 1
fi

echo "‚ûï A√±adiendo $REPO a workspace $WORKSPACE_NAME (branch: $BRANCH_NAME)"

# Crear estructura de subdirectorios si es necesario
WORKTREE_PARENT=$(dirname "$WORKTREE_PATH")
mkdir -p "$WORKTREE_PARENT"

cd $REPO_PATH

# Para features, crear branch si no existe
if [ "$WORKSPACE_NAME" != "master" ] && [ "$WORKSPACE_NAME" != "develop" ]; then
    git rev-parse --verify $BRANCH_NAME >/dev/null 2>&1
    if [ $? -ne 0 ]; then
        echo "  ‚ûï Creando branch: $BRANCH_NAME"
        git branch $BRANCH_NAME
    fi
fi

# Crear worktree
git worktree add $WORKTREE_PATH $BRANCH_NAME

echo "‚úÖ Repo a√±adido: $WORKTREE_PATH"
echo "   Branch: $BRANCH_NAME"
