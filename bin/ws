#!/bin/bash
# Workspace Tools - Comando principal
# Dispatcher para los subcomandos de workspace management

# Detectar directorio del script (compatible bash/zsh)
if [ -n "$BASH_SOURCE" ]; then
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
else
    SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
fi

# Subcomando (primer argumento)
SUBCOMMAND=$1

# Funci√≥n de ayuda
show_help() {
    cat <<'EOF'
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  Workspace Tools                                   ‚ïë
‚ïë  Sistema de gesti√≥n de workspaces nubarchiva       ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

Uso: ws <comando> [argumentos...]

Comandos disponibles:

  new <nombre> [repos...]
      Crea un nuevo workspace
      Ejemplos:
        ws new nuba-8400 ks-nuba libs/marc4j
        ws new faceted-search ks-nuba
        ws new master ks-nuba
        ws new develop

  add <nombre|patr√≥n> <repo>
      A√±ade un repo a un workspace existente
      Ejemplos:
        ws add nuba-8400 libs/marc4j
        ws add fac modules/docs            # coincidencia parcial
        ws add master ks-nuba

  switch [nombre|patr√≥n]
      Cambia a un workspace y muestra su informaci√≥n
      Ejemplos:
        ws switch                          # lista todos
        ws switch nuba-8400
        ws switch fac                      # coincidencia parcial
        ws switch master

  list
      Lista todos los workspaces activos
      Ejemplo:
        ws list

  clean <nombre|patr√≥n>
      Limpia un workspace (elimina worktrees, mantiene branches)
      Ejemplos:
        ws clean nuba-8400
        ws clean fac                       # coincidencia parcial
        ws clean master

  mvn <nombre|patr√≥n> <argumentos-maven>
      Ejecuta comandos Maven en todos los proyectos del workspace
      Ejemplos:
        ws mvn nuba-8400 clean install
        ws mvn master test
        ws mvn fac clean compile           # coincidencia parcial

  git <nombre|patr√≥n> <comando-git> [argumentos...]
      Ejecuta comandos Git en todos los repos del workspace
      Ejemplos:
        ws git nuba-8400 status
        ws git master pull
        ws git fac log --oneline -5        # coincidencia parcial

Nombres especiales:
  ‚Ä¢ master   - Workspace en branch master
  ‚Ä¢ develop  - Workspace en branch develop
  ‚Ä¢ otros    - Workspace en branch feature/<nombre>

üí° Abreviaturas de comandos:
  Puedes usar abreviaturas de comandos:
  ‚Ä¢ Autom√°ticas: n, a, l, c, cl, etc. (cualquier prefijo √∫nico)
  ‚Ä¢ Predefinidas: ls‚Üílist, cd‚Üíswitch, sw‚Üíswitch, rm‚Üíclean, del‚Üíclean,
                  mk‚Üínew, create‚Üínew, h‚Üíhelp

üí° B√∫squeda parcial de workspaces:
  Puedes usar partes del nombre en lugar del nombre completo.
  Si hay m√∫ltiples coincidencias, se mostrar√° un men√∫ interactivo.

Ejemplos con abreviaturas:
  ws n nuba-8400 ks-nuba         # ws new
  ws a master libs/marc4j        # ws add
  ws ls                          # ws list
  ws cd nuba-8400                # ws switch
  ws rm nuba-8400                # ws clean

Compatibilidad:
  Los comandos individuales (ws-new, ws-add, etc.) siguen disponibles

Documentaci√≥n:
  README.md       - Gu√≠a completa
  EJEMPLOS.md     - Casos de uso pr√°cticos
  CHEATSHEET.md   - Referencia r√°pida
  QUICKSTART.md   - Inicio r√°pido

EOF
}

# Si no hay argumentos, mostrar ayuda
if [ -z "$SUBCOMMAND" ]; then
    show_help
    exit 0
fi

# Funci√≥n para expandir abreviaturas
expand_abbreviation() {
    local abbrev=$1
    local commands="new add switch list clean mvn git help"

    # Aliases predefinidos
    case $abbrev in
        ls) echo "list"; return 0 ;;
        rm|del) echo "clean"; return 0 ;;
        cd|sw) echo "switch"; return 0 ;;
        mk|create) echo "new"; return 0 ;;
        h) echo "help"; return 0 ;;
    esac

    # Expansi√≥n autom√°tica por coincidencia parcial
    local matches=()
    for cmd in $commands; do
        if [[ "$cmd" == "$abbrev"* ]]; then
            matches+=("$cmd")
        fi
    done

    # Analizar resultados
    if [ ${#matches[@]} -eq 0 ]; then
        # No hay coincidencias, devolver el original
        echo "$abbrev"
        return 1
    elif [ ${#matches[@]} -eq 1 ]; then
        # Una sola coincidencia, expandir
        echo "${matches[0]}"
        return 0
    else
        # M√∫ltiples coincidencias, error ambiguo
        echo "‚ùå Comando ambiguo: '$abbrev' coincide con: ${matches[*]}" >&2
        return 1
    fi
}

# Expandir abreviatura
EXPANDED=$(expand_abbreviation "$SUBCOMMAND")
if [ $? -eq 0 ]; then
    SUBCOMMAND="$EXPANDED"
fi

# Mapear subcomandos a scripts
case $SUBCOMMAND in
    new|add|switch|list|clean|mvn|git)
        SCRIPT_NAME="ws-$SUBCOMMAND"
        SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_NAME"
        
        # Verificar que el script existe
        if [ ! -f "$SCRIPT_PATH" ]; then
            echo "‚ùå Error: comando '$SUBCOMMAND' no encontrado"
            echo ""
            show_help
            exit 1
        fi
        
        # Ejecutar el script correspondiente, pasando todos los argumentos excepto el primero
        shift
        exec "$SCRIPT_PATH" "$@"
        ;;
    
    help|--help|-h)
        show_help
        exit 0
        ;;
    
    *)
        echo "‚ùå Comando desconocido: $SUBCOMMAND"
        echo ""
        show_help
        exit 1
        ;;
esac
