#!/bin/bash
# Ejecuta comandos Maven en todos los proyectos de un workspace

# Detectar WORKSPACE_ROOT desde WS_TOOLS o por defecto
if [ -n "$WS_TOOLS" ]; then
    WORKSPACE_ROOT="${WS_TOOLS%/tools/workspace-tools}"
else
    # Fallback: asumir ubicaciÃ³n estÃ¡ndar
    WORKSPACE_ROOT=~/wrkspc.nubarchiva
fi
WORKSPACES_DIR=$WORKSPACE_ROOT/workspaces

# Detectar directorio del script (compatible bash/zsh)
if [ -n "$BASH_SOURCE" ]; then
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
else
    SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
fi

# Cargar funciones compartidas
source "$SCRIPT_DIR/ws-common.sh"
source "$SCRIPT_DIR/ws-colors.sh"

# Determinar workspace y argumentos
# Prioridad: 1) Workspace explÃ­cito si $1 coincide con uno existente
#            2) Auto-detecciÃ³n si estamos dentro de un workspace
#            3) Modo tradicional (primer arg es workspace)
WORKSPACE_PATTERN=""
MVN_ARGS=""

if [ -n "$1" ]; then
    # Verificar si primer argumento corresponde a un workspace existente
    first_arg_lower=$(echo "$1" | tr '[:upper:]' '[:lower:]')
    is_workspace=false

    if [ -d "$WORKSPACES_DIR" ]; then
        for ws_dir in "$WORKSPACES_DIR"/*; do
            if [ -d "$ws_dir" ]; then
                ws_name=$(basename "$ws_dir")
                ws_name_lower=$(echo "$ws_name" | tr '[:upper:]' '[:lower:]')
                if [[ "$ws_name_lower" == *"$first_arg_lower"* ]]; then
                    is_workspace=true
                    break
                fi
            fi
        done
    fi

    if [ "$is_workspace" = true ]; then
        # Primer argumento coincide con workspace â†’ modo explÃ­cito
        WORKSPACE_PATTERN="$1"
        shift
        MVN_ARGS="$@"
    else
        # Primer argumento NO es workspace â†’ intentar auto-detecciÃ³n
        DETECTED_WORKSPACE=$(detect_current_workspace 2>/dev/null || true)
        if [ -n "$DETECTED_WORKSPACE" ]; then
            # Auto-detectado, todos los args son para Maven
            WORKSPACE_PATTERN="$DETECTED_WORKSPACE"
            MVN_ARGS="$@"
        else
            # No auto-detectado, asumir modo tradicional
            WORKSPACE_PATTERN="$1"
            shift
            MVN_ARGS="$@"
        fi
    fi
else
    # Sin argumentos, intentar auto-detecciÃ³n
    DETECTED_WORKSPACE=$(detect_current_workspace 2>/dev/null || true)
    if [ -n "$DETECTED_WORKSPACE" ]; then
        WORKSPACE_PATTERN="$DETECTED_WORKSPACE"
        # Si primer argumento estÃ¡ vacÃ­o (ej: wmci sin args), saltarlo
        if [ "$#" -gt 0 ] && [ -z "$1" ]; then
            shift
        fi
        MVN_ARGS="$@"
    fi
fi

# FunciÃ³n de ayuda
show_help() {
    echo "Uso: ws mvn <nombre|patrÃ³n> <argumentos-maven>"
    echo ""
    echo "Ejecuta comandos Maven en todos los proyectos de un workspace."
    echo ""
    echo "ğŸ’¡ Puedes usar coincidencia parcial para el nombre del workspace"
    echo ""
    echo "Ejemplos:"
    echo "  ws mvn nuba-8400 clean install"
    echo "  ws mvn master test"
    echo "  ws mvn fac clean compile     # bÃºsqueda parcial"
    echo ""
    echo "Comportamiento:"
    echo "  â€¢ Busca pom.xml en la raÃ­z de cada repo del workspace"
    echo "  â€¢ Ejecuta 'mvn <args> -f <repo>/pom.xml' en cada proyecto"
    echo "  â€¢ Se detiene en el primer error"
    echo "  â€¢ Ignora repos sin pom.xml con un mensaje informativo"
    echo ""
    echo "Orden de compilaciÃ³n:"
    echo "  Si existe .ws-build-order en el workspace, se usa ese orden."
    echo "  Formato del archivo (una lÃ­nea por repo):"
    echo "    # Comentarios con #"
    echo "    dga-commons"
    echo "    ks-nuba"
    echo "    modules/diffusion-portal"
}

# Si no se especificÃ³ workspace, intentar detectar automÃ¡ticamente
if [ -z "$WORKSPACE_PATTERN" ]; then
    WORKSPACE_PATTERN=$(detect_current_workspace)
    if [ -z "$WORKSPACE_PATTERN" ]; then
        error "âŒ Error: no se especificÃ³ workspace y no se pudo detectar automÃ¡ticamente"
        echo ""
        info "ğŸ’¡ Ejecuta este comando desde dentro de un workspace o especifica el nombre:"
        echo "   ws mvn <workspace> <argumentos-maven>"
        echo ""
        show_help
        exit 1
    fi
    info "ğŸ” Workspace detectado: $WORKSPACE_PATTERN"
fi

if [ -z "$MVN_ARGS" ]; then
    error "âŒ Error: debes especificar argumentos para Maven"
    echo ""
    show_help
    exit 1
fi

# Buscar workspace que coincida con el patrÃ³n
WORKSPACE_NAME=$(find_matching_workspace "$WORKSPACE_PATTERN" "$WORKSPACES_DIR")
if [ $? -ne 0 ]; then
    exit 1
fi

# Determinar directorio del workspace
WORKSPACE_DIR=$WORKSPACES_DIR/$WORKSPACE_NAME
BRANCH_NAME=$(get_branch_name "$WORKSPACE_NAME")

if [ ! -d "$WORKSPACE_DIR" ]; then
    error "âŒ Workspace no existe: $WORKSPACE_NAME"
    exit 1
fi

print_header "Ejecutando Maven en workspace"
echo ""
echo "Workspace: ${COLOR_CYAN}$WORKSPACE_NAME${COLOR_RESET}"
echo "Branch:    ${COLOR_CYAN}$BRANCH_NAME${COLOR_RESET}"
echo "Comando:   ${COLOR_BOLD}mvn $MVN_ARGS${COLOR_RESET}"
echo ""

# Encontrar todos los repos en el workspace
# Si existe .ws-build-order, usar ese orden; sino, usar find_repos_in_workspace
BUILD_ORDER_FILE="$WORKSPACE_DIR/.ws-build-order"

if [ -f "$BUILD_ORDER_FILE" ]; then
    # Usar orden definido en el archivo (ignorar lÃ­neas vacÃ­as y comentarios)
    repos=$(grep -v '^#' "$BUILD_ORDER_FILE" | grep -v '^$')
    info "ğŸ“‹ Usando orden de compilaciÃ³n de .ws-build-order"
    echo ""
else
    repos=$(find_repos_in_workspace "$WORKSPACE_DIR")
fi

if [ -z "$repos" ] || [ "$repos" = "" ]; then
    error "âŒ No hay repos en este workspace"
    exit 1
fi

# Contar proyectos Maven
maven_projects=0
skipped_repos=0

# Archivo temporal para almacenar tiempos de ejecuciÃ³n
temp_times=$(mktemp)
trap "rm -f $temp_times" EXIT

# Ejecutar Maven en cada repo que tenga pom.xml
echo "$repos" | while read -r repo_rel_path; do
    if [ -n "$repo_rel_path" ]; then
        repo_path="$WORKSPACE_DIR/$repo_rel_path"
        pom_path="$repo_path/pom.xml"

        if [ -f "$pom_path" ]; then
            ((maven_projects++))
            print_separator_with_title "Ejecutando en: ${COLOR_CYAN}$repo_rel_path${COLOR_RESET}"
            echo ""

            # Capturar tiempo de inicio
            start_time=$(date +%s)

            # Ejecutar Maven
            mvn $MVN_ARGS -f "$pom_path"

            # Verificar el resultado
            exit_code=$?

            # Capturar tiempo de fin
            end_time=$(date +%s)
            elapsed=$((end_time - start_time))

            # Guardar tiempo en archivo temporal
            echo "$repo_rel_path|$elapsed" >> "$temp_times"

            if [ $exit_code -ne 0 ]; then
                echo ""
                error "âŒ Error en $repo_rel_path (exit code: $exit_code)"
                error "   Deteniendo ejecuciÃ³n"
                exit $exit_code
            fi

            echo ""
        else
            ((skipped_repos++))
            info "â„¹ï¸  Ignorando $repo_rel_path (no tiene pom.xml)"
        fi
    fi
done

# Capturar el exit code del while loop
exit_code=$?

if [ $exit_code -ne 0 ]; then
    exit $exit_code
fi

echo ""
success "âœ… Maven ejecutado correctamente en todos los proyectos"
if [ $skipped_repos -gt 0 ]; then
    echo "   ${COLOR_DIM}($skipped_repos repos ignorados por no tener pom.xml)${COLOR_RESET}"
fi

# Mostrar resumen de tiempos
if [ -f "$temp_times" ] && [ -s "$temp_times" ]; then
    echo ""
    echo "${COLOR_BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${COLOR_RESET}"
    echo "${COLOR_BOLD}Resumen de ejecuciÃ³n:${COLOR_RESET}"
    echo "${COLOR_BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${COLOR_RESET}"

    total_time=0
    while IFS='|' read -r project time; do
        total_time=$((total_time + time))
        # Formatear nombre del proyecto con puntos para alineaciÃ³n
        printf "  â€¢ %-40s ${COLOR_DIM}%5ss${COLOR_RESET}\n" "$project" "$time"
    done < "$temp_times"

    echo "${COLOR_DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${COLOR_RESET}"
    printf "  ${COLOR_BOLD_GREEN}Total: %ss${COLOR_RESET}\n" "$total_time"
fi
