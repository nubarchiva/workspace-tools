#!/bin/bash
# Limpia un workspace terminado (elimina worktrees pero mantiene branches)
# Soporta repos en subdirectorios

WORKSPACE_PATTERN=$1

# Detectar WORKSPACE_ROOT desde WS_TOOLS o por defecto
if [ -n "$WS_TOOLS" ]; then
    WORKSPACE_ROOT="${WS_TOOLS%/tools/workspace-tools}"
else
    # Fallback: asumir ubicaci√≥n est√°ndar
    WORKSPACE_ROOT=~/wrkspc.nubarchiva
fi
WORKSPACES_DIR=$WORKSPACE_ROOT/workspaces

# Detectar directorio del script (compatible bash/zsh)
if [ -n "$BASH_SOURCE" ]; then
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
else
    SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
fi

# Cargar funciones compartidas
source "$SCRIPT_DIR/ws-common.sh"
source "$SCRIPT_DIR/ws-colors.sh"

# Funci√≥n de ayuda
show_help() {
    echo "Uso: ws clean [nombre|patr√≥n]"
    echo ""
    echo "Elimina los worktrees de un workspace pero mantiene las branches."
    echo ""
    echo "üí° Puedes usar coincidencia parcial para el nombre del workspace"
    echo ""
    echo "Ejemplos:"
    echo "  ws clean master"
    echo "  ws clean develop"
    echo "  ws clean nuba-8400"
    echo "  ws clean fac                     # b√∫squeda parcial"
    echo ""
    echo "‚ö†Ô∏è  Este comando:"
    echo "  ‚Ä¢ Elimina los directorios de worktree"
    echo "  ‚Ä¢ Mantiene las branches en los repos principales"
    echo "  ‚Ä¢ NO elimina commits ni cambios commiteados"
}

if [ -z "$WORKSPACE_PATTERN" ]; then
    show_help
    exit 1
fi

# Buscar workspace que coincida con el patr√≥n
WORKSPACE_NAME=$(find_matching_workspace "$WORKSPACE_PATTERN" "$WORKSPACES_DIR")
if [ $? -ne 0 ]; then
    exit 1
fi

# Determinar directorio del workspace
WORKSPACE_DIR=$WORKSPACES_DIR/$WORKSPACE_NAME
BRANCH_NAME=$(get_branch_name "$WORKSPACE_NAME")

if [ ! -d "$WORKSPACE_DIR" ]; then
    error "‚ùå Workspace no existe: $WORKSPACE_NAME"
    exit 1
fi

# Mostrar qu√© se va a eliminar
warning "‚ö†Ô∏è  Vas a limpiar el workspace: ${COLOR_BOLD}$WORKSPACE_NAME${COLOR_RESET} (branch: ${COLOR_CYAN}$BRANCH_NAME${COLOR_RESET})"
echo ""
echo "Repos afectados:"

repos=$(find_repos_in_workspace "$WORKSPACE_DIR")
has_repos=false
has_uncommitted_changes=false

echo "$repos" | while read -r repo_rel_path; do
    if [ -n "$repo_rel_path" ]; then
        has_repos=true
        worktree_path="$WORKSPACE_DIR/$repo_rel_path"
        echo "  ‚Ä¢ ${COLOR_CYAN}$repo_rel_path${COLOR_RESET}"

        # Verificar si hay cambios sin commitear
        if [ -d "$worktree_path" ]; then
            cd "$worktree_path"
            if [ -n "$(git status -s 2>/dev/null)" ]; then
                warning "    ‚ö†Ô∏è  TIENE CAMBIOS SIN COMMITEAR"
                has_uncommitted_changes=true
            fi
        fi
    fi
done

if [ -z "$repos" ] || [ "$repos" = "" ]; then
    echo "  ${COLOR_DIM}(No hay repos en este workspace)${COLOR_RESET}"
fi

echo ""
echo "Esto eliminar√° los worktrees pero mantendr√° las branches en los repos principales."
echo ""
read -p "¬øContinuar? (s/n) " -n 1 -r
echo

if [[ ! $REPLY =~ ^[Ss]$ ]]; then
    error "‚ùå Cancelado"
    exit 1
fi

# Eliminar cada worktree
echo ""
info "Limpiando worktrees..."

echo "$repos" | while read -r repo_rel_path; do
    if [ -n "$repo_rel_path" ]; then
        worktree_path="$WORKSPACE_DIR/$repo_rel_path"

        if [ -d "$worktree_path" ]; then
            echo "  ${COLOR_DIM}üóëÔ∏è  Eliminando worktree: $repo_rel_path${COLOR_RESET}"

            cd "$worktree_path"

            # Obtener el directorio del repo principal
            # Para git worktrees, .git puede ser un archivo o directorio
            if [ -f "$worktree_path/.git" ]; then
                # Es un worktree (archivo .git apunta al repo principal)
                MAIN_REPO=$(grep "gitdir:" "$worktree_path/.git" | cut -d' ' -f2 | sed 's|/\.git/worktrees/.*||')
            else
                # Es el repo principal o un caso especial
                MAIN_REPO=$(git rev-parse --git-common-dir 2>/dev/null | sed 's|/\.git.*||')
            fi

            # Volver al repo principal y eliminar worktree
            if [ -d "$MAIN_REPO" ]; then
                cd "$MAIN_REPO"
                git worktree remove "$worktree_path" --force 2>/dev/null || {
                    # Si falla, intentar eliminar manualmente
                    rm -rf "$worktree_path"
                    git worktree prune
                }
                success "     ‚úÖ Eliminado"
            else
                warning "     ‚ö†Ô∏è  No se pudo encontrar repo principal, eliminando directorio"
                rm -rf "$worktree_path"
            fi
        fi
    fi
done

# Eliminar directorio del workspace (y sus subdirectorios vac√≠os)
if [ -d "$WORKSPACE_DIR" ]; then
    # Eliminar directorios vac√≠os recursivamente
    find "$WORKSPACE_DIR" -type d -empty -delete 2>/dev/null || true

    # Archivos/directorios que deben ignorarse (creados por workspace-tools)
    # - .idea/, .vscode/, .kiro/, .cursor/: configuraci√≥n IDE/AI copiada por copy_workspace_config
    # - AI.md, .ai/, docs/: symlinks creados por copy_workspace_config
    ignore_patterns=(".idea" ".vscode" ".kiro" ".cursor" "AI.md" ".ai" "docs")

    # Contar archivos que NO deben ignorarse
    significant_files=0
    all_files=()

    # Leer todos los archivos en el directorio
    while IFS= read -r file; do
        all_files+=("$file")
    done < <(ls -A "$WORKSPACE_DIR" 2>/dev/null)

    # Contar archivos significativos (que no est√°n en la lista de ignorados)
    for file in "${all_files[@]}"; do
        should_ignore=false
        for pattern in "${ignore_patterns[@]}"; do
            if [ "$file" = "$pattern" ]; then
                should_ignore=true
                break
            fi
        done

        if [ "$should_ignore" = false ]; then
            ((significant_files++))
        fi
    done

    # Si no hay archivos significativos, eliminar todo el workspace
    if [ $significant_files -eq 0 ]; then
        rm -rf "$WORKSPACE_DIR"
    else
        # Hay archivos del usuario, no eliminar
        echo ""
        warning "‚ö†Ô∏è  El workspace tiene archivos adicionales del usuario. No se elimin√≥ el directorio."
        echo "   Revisa: $WORKSPACE_DIR"
        echo "   Archivos restantes:"
        for file in "${all_files[@]}"; do
            is_ignored=false
            for pattern in "${ignore_patterns[@]}"; do
                if [ "$file" = "$pattern" ]; then
                    is_ignored=true
                    break
                fi
            done
            if [ "$is_ignored" = false ]; then
                echo "      ‚Ä¢ $file"
            fi
        done
    fi
fi

echo ""
success "‚úÖ Workspace limpiado: $WORKSPACE_NAME"
echo ""
info "üí° La branch se mantiene en los repos principales:"
echo "   Branch: ${COLOR_CYAN}$BRANCH_NAME${COLOR_RESET}"
echo ""
echo "Para ver branches en un repo:"
echo "  ${COLOR_DIM}cd $WORKSPACE_ROOT/<repo> && git branch -a${COLOR_RESET}"
